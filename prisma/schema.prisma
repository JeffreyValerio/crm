// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String?
  role              String    @default("user")
  inviteToken       String?   @unique
  invitedAt         DateTime?
  invitedBy         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  clients           Client[]
  statusComments    StatusComment[]
  payrolls          Payroll[]
  approvedPayrolls  Payroll[] @relation("PayrollApprover")
  advances          Advance[]
  approvedAdvances  Advance[] @relation("AdvanceApprover")
}

model ProductType {
  id          String   @id @default(cuid())
  nombre      String   @unique
  descripcion String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  products    Plan[]
}

model Plan {
  id            String      @id @default(cuid())
  nombre        String
  descripcion   String?
  activo        Boolean      @default(true)
  productTypeId String?
  productType   ProductType? @relation(fields: [productTypeId], references: [id])
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  clients       Client[]
}

enum TipoIdentificacion {
  NACIONAL
  DIMEX
  PASAPORTE
  JURIDICA
}

enum ValidationStatus {
  EN_PROCESO_VALIDACION
  APROBADA
  REQUIERE_DEPOSITO
  NO_APLICA
  INCOBRABLE
  DEUDA_MENOR_ANIO
}

enum SaleStatus {
  PENDIENTE_INSTALACION
  INSTALADA
  CANCELADA
}

enum PayrollStatus {
  PENDIENTE
  APROBADO
  PAGADO
}

enum AdvanceStatus {
  PENDIENTE
  APROBADO
  RECHAZADO
  EN_COBRO
  COMPLETADO
}

model Client {
  id                    String             @id @default(cuid())
  // Fotos
  cedulaFrontalUrl      String?
  cedulaTraseraUrl      String?
  selfieUrl             String?
  // Datos personales
  nombres               String
  apellidos             String
  tipoIdentificacion    TipoIdentificacion
  numeroIdentificacion  String
  fechaNacimiento       DateTime?
  stb                   Int?
  // Contacto
  email                 String?
  telefono              String?
  // Ubicación
  provincia             String
  canton                String
  distrito              String
  senasExactas          String
  coordenadasLat        String?
  coordenadasLng        String?
  // Técnico
  numeroMedidor         String?
  // Plan
  planId                String?
  plan                  Plan?              @relation(fields: [planId], references: [id])
  // Estados
  validationStatus      ValidationStatus?  @default(EN_PROCESO_VALIDACION)
  validationComment     String?
  saleStatus            SaleStatus?
  saleComment           String?
  // Metadatos
  createdBy             String
  creator               User               @relation(fields: [createdBy], references: [id])
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  statusComments        StatusComment[]
}

model StatusComment {
  id            String   @id @default(cuid())
  clientId      String
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tipo          String   // "VALIDACION" o "VENTA"
  estadoAnterior String?
  estadoNuevo   String
  comentario    String
  createdBy     String
  creator       User     @relation(fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
}

model Payroll {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  periodo         String        // Formato: "YYYY-MM" (ej: "2025-01")
  quincena        Int           // 1 o 2
  diasEsperados   Int                            // Días laborables esperados en la quincena
  diasTrabajados  Int                            // Días realmente trabajados (editable por admin)
  salarioBase     Decimal                       // Salario por quincena en colones
  montoDiario     Decimal                       // Calculado: salarioBase / diasTrabajados
  total           Decimal       // Calculado: salarioBase
  estado          PayrollStatus @default(PENDIENTE)
  aprobadoPor     String?
  aprobador       User?         @relation("PayrollApprover", fields: [aprobadoPor], references: [id])
  aprobadoAt      DateTime?
  fechaPago       DateTime?
  comprobanteUrl  String?
  observaciones   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([userId, periodo, quincena])
  @@index([userId])
  @@index([periodo])
  @@index([estado])
}

model Advance {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  monto           Decimal       // Monto solicitado en colones
  quincenas       Int           @default(1) // En cuántas quincenas se cobrará
  montoRestante   Decimal       // Monto que falta por cobrar
  estado          AdvanceStatus @default(PENDIENTE)
  observaciones   String?       // Observaciones de la solicitud
  aprobadoPor     String?
  aprobador       User?         @relation("AdvanceApprover", fields: [aprobadoPor], references: [id])
  aprobadoAt      DateTime?
  rechazadoAt     DateTime?
  completadoAt    DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([estado])
}